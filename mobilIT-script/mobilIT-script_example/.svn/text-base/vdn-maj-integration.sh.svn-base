#!/bin/bash
###############################################################################
#
### DESCRIPTION
# Script de mise à jour de la plateforme d'integration
#
###  HISTORIQUE
# 11/02/2011 - V1.0 : version initiale (frleq)
# 31/03/2011 - V1.1 : integration continue (besim)
# 18/04/2011 - V1.2 : copie de web.xml (frleq)
# 20/04/2011 - V1.3 : reset de SolR (frleq)
###############################################################################

###############################################################################
### Loading the environment file with the extention ".cfg" intead of ".sh"
###############################################################################
source  ./`basename $0 .sh`.cfg

###############################################################################
# CONSTANTES
###############################################################################
DATE=`date +%Y%m%d-%H%M`
WORK=$PWD

###############################################################################
# FUNCTIONS
###############################################################################
function checkPreviousCMD(){
  if [ $? -ne 0 ]; then
	  #echo -e "\033[31m[KO]"
	  #tput sgr0
	  exit 3
  #else
	  #echo -e "\033[32m[OK]"
	  #tput sgr0
  fi
  echo
}

function resetLiferay(){

  rm -Rf $SCRIPT_FOLDER_PORTLET/*
  stopTomcat
  echo
  echo "Attente 10sec que le serveur soit bien down..."
  sleep 10
  echo
  echo "Suppression du Liferay"
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/ROOT
  echo "Suppression des portlets"
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/liferay-*
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/kaleo-web*
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/social-networking-*
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/weather*
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/web-form*
  rm -rf /opt/liferay-ee-6.0.1/tomcat/webapps/solr-*
  rm -rf /opt/liferay-ee-6.0.1/deploy/*
  checkPreviousCMD

  echo "Suppression des fichiers temporaires"
  rm -rf $LIFERAY_FOLDER/work/*
  checkPreviousCMD

  echo "Restauration du fichier d'archive Liferay"
  cd backup
  tar -zxf $LIFERAY_BACKUP_FILE -C /opt/liferay-ee-6.0.1/tomcat/webapps
  cd ..
  checkPreviousCMD

  echo "Restauration du fichier web.xml (cf LPS-8536)"
  cp $WEBXML_LIFERAY_BACKUP /opt/liferay-ee-6.0.1/tomcat/webapps/ROOT/WEB-INF/
  checkPreviousCMD

  echo "Reset de SolR"
  echo "Sorl URL is $SOLR_URL"
  curl $SOLR_URL -H "Content-Type: text/xml" --data-binary '<delete><query>*:*</query></delete>' 
  curl $SOLR_URL -H "Content-Type: text/xml" --data-binary '<commit waitFlush="false" waitSearcher="false"/>'
  checkPreviousCMD

  echo "Restauration de la base SQL vide"
  mysql -u$MYSQL_USER -e "DROP DATABASE IF EXISTS $MYSQL_DATABASE"
  mysql -u$MYSQL_USER -e "CREATE DATABASE $MYSQL_DATABASE CHARACTER SET utf8 COLLATE utf8_general_ci;"
  mysql -u$MYSQL_USER $MYSQL_DATABASE < $SCRIPT_BDD_BACKUP
  checkPreviousCMD

  startTomcat

  deployPortletsFromBackupFolder

  echo "Attente du déploiement des portlets requises pour l'initialisation"
  sleep 25

}

#
# Deploy a portlet
# arg0: portlet filename
#
function deployPortlet(){
  echo "deploy portlet $1"
  cp $SCRIPT_FOLDER_PORTLET$1 $LIFERAY_DEPLOY_FOLDER
  checkPreviousCMD
}

#
# Deploy  portlets froms a folder
# arg0: folder
#
function deployPortletFromFolder(){
  echo "Déploiement des portlets à partir du répertoire $SCRIPT_FOLDER_PORTLET"
  for f in $SCRIPT_FOLDER_PORTLET/*.war
  do
    echo "Déploiement de $(basename $f)"
    deployPortlet $(basename $f) 
  done
}

#
# Deploy  portlets froms backup folder
# arg0: folder
#
function deployPortletsFromBackupFolder(){
  echo "Déploiement des portlets requises pour l'initialisation du portail"
  for f in $SCRIPT_FOLDER_BACKUP/*.war
  do
    echo "Déploiement de $(basename $f)"
    cp $f $LIFERAY_DEPLOY_FOLDER
  done
  chown tomcat /opt/liferay-ee-6.0.1/deploy/*
  chgrp tomcat /opt/liferay-ee-6.0.1/deploy/*
}

#
# Start & Stop serevr
#
function stopTomcat(){
  echo "Arret Tomcat"
  /etc/init.d/liferay stop
  checkPreviousCMD
}
function stopBdd(){
  echo "Arret de MySQL"
  /etc/init.d/mysqld stop
  checkPreviousCMD
}
function startTomcat(){
  echo "Start de Tomcat"
  /etc/init.d/liferay start
  checkPreviousCMD
}
function startBdd(){
  echo "Start de MySQL"
  /etc/init.d/mysqld start
  checkPreviousCMD
}


###############################################################################
# PROGRAMME
###############################################################################
#clear

echo "*****************************************************"
echo " VDN - SCRIPT DE MAJ DE LA PLATE FORME D'INTEGRATION "
echo "*****************************************************"
echo ""

if [ $1 ]; then
  #MAJ unitaire d'une portlet
  deployPortlet $1
else
  #MAJ de la plateforme complète
  # 1: reset de liferay
  resetLiferay
  rm -rf $SCRIPT_FOLDER_PORTLET/*.war
  # 2: deploy portlets
  #deployPortletFromFolder 
fi

chown -R $LIFERAY_UNIX_USER:$LIFERAY_UNIX_GOURP $LIFERAY_FOLDER

exit 0
